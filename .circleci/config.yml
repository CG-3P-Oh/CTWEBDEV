version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install lftp
          command: sudo apt-get update && sudo apt-get install -y lftp
      - run:
          name: Restore file timestamps from git
          command: |
            cd site
            git ls-files -z | while IFS= read -r -d '' file; do
              if [ -f "$file" ]; then
                touch -d "$(git log -1 --format='%cI' -- "$file")" "$file" 2>/dev/null || true
              fi
            done
      - run:
          name: Deploy to staging
          command: |
            lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "
              set ftp:ssl-protect-data true
              set ssl:verify-certificate no
              mirror -R --verbose --only-newer --exclude .git/ --exclude .circleci/ ./site staging.ctwebdevelopment.com
              quit
            "

workflows:
  deploy-workflow:
    jobs:
      - deploy:
          filters:
            branches:
              only: main